import { __awaiter } from "tslib";
import * as THREE from 'three';
import { STLLoader } from 'three/examples/jsm/loaders/STLLoader';
const MATERIAL_0 = (color = 0xffffff) => new THREE.MeshPhongMaterial({
    color,
    flatShading: true,
    side: THREE.DoubleSide,
    wireframe: false,
});
const LIGHT_0 = new THREE.AmbientLight(0xffffff, 0.3);
const LIGHT_1 = new THREE.DirectionalLight(0xffffff, 0.2);
LIGHT_1.position.set(-100, -100, 100);
LIGHT_1.lookAt(new THREE.Vector3(0, 0, 0));
const LIGHT_2 = new THREE.DirectionalLight(0xffffff, 0.2);
LIGHT_2.position.set(100, 0, 0);
LIGHT_2.lookAt(new THREE.Vector3(0, 0, 0));
const LIGHT_3 = new THREE.DirectionalLight(0xffffff, 0.2);
LIGHT_3.position.set(-20, 100, 0);
LIGHT_3.lookAt(new THREE.Vector3(0, 0, 0));
const LIGHT_4 = new THREE.DirectionalLight(0xffffff, 0.4);
LIGHT_4.position.set(50, 50, 0);
LIGHT_4.lookAt(new THREE.Vector3(-100, 0, 0));
export class StlSnapshotService {
    constructor(file, ppmm) {
        this.file = file;
        this.ppmm = ppmm;
        this.canvas = document.createElement('canvas');
        this.stlLoader = new STLLoader();
        this.scene = new THREE.Scene();
        this.objects = new THREE.Group();
        this.lights = new THREE.Group();
        this.sideLength = 0;
        this.distance = 10;
    }
    read() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.file instanceof File) {
                this.file = yield new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsArrayBuffer(this.file);
                });
            }
            return this.file;
        });
    }
    snapshot(fileSave) {
        return __awaiter(this, void 0, void 0, function* () {
            this.init(yield this.read());
            return yield this.shot(fileSave);
        });
    }
    init(data) {
        this.geometry = this.stlLoader.parse(data);
        this.geometry.computeBoundingBox();
        this.geometry.center();
        this.geometry.computeBoundingSphere();
        const { x, y, z } = this.geometry.boundingBox.max;
        this.distance = Math.max(x, y, z) * 10;
        const { center, radius } = this.geometry.boundingSphere;
        console.debug(center, radius, x, y, z);
        this.center = center;
        this.sideLength = radius * 2;
        this.canvas.height = this.canvas.width = this.sideLength * this.ppmm;
        this.renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: true,
            canvas: this.canvas,
        });
        this.camera = new THREE.PerspectiveCamera(15, 1);
        this.camera.position.set(0, this.distance, 0);
        this.camera.lookAt(center);
        this.lights.add(LIGHT_0, LIGHT_1, LIGHT_2, LIGHT_3);
        this.camera.add(LIGHT_4);
        const mesh = new THREE.Mesh(this.geometry, MATERIAL_0(0xffffff));
        mesh.rotateOnWorldAxis(new THREE.Vector3(0, 1, 0), -Math.PI / 2);
        this.objects.add(mesh);
        this.scene.add(this.camera, this.objects, this.lights);
        this.renderer.render(this.scene, this.camera);
    }
    shot(fileSave) {
        return __awaiter(this, void 0, void 0, function* () {
            const images = [];
            const positions = [
                [0, this.distance, 0],
                [0, -this.distance, 0],
                [this.distance, 0, 0],
                [-this.distance, 0, 0],
                [0, 0, this.distance],
                [0, 0, -this.distance],
            ];
            for (const p of positions) {
                this.camera.position.set(p[0], p[1], p[2]);
                this.camera.lookAt(this.center);
                this.camera.up.set(0, 0, p.some((x) => x > 0) ? -1 : 1);
                this.camera.updateProjectionMatrix();
                this.renderer.render(this.scene, this.camera);
                yield new Promise((resolve, reject) => setTimeout(resolve));
                const dataURL = this.canvas.toDataURL('image/png');
                images.push(dataURL);
                if (fileSave) {
                    fileSave(dataURL.replace(/^data:image\/\w+;base64,/, ''));
                }
            }
            return {
                images,
                sideLength: this.sideLength,
                ppmm: this.ppmm,
            };
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RsLXNuYXBzaG90LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLXN0bC1tb2RlbC12aWV3ZXIvc3JjL2xpYi9zdGwtc25hcHNob3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFFL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBRWpFLE1BQU0sVUFBVSxHQUFHLENBQUMsS0FBSyxHQUFHLFFBQVEsRUFBRSxFQUFFLENBQ3RDLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDO0lBQzFCLEtBQUs7SUFDTCxXQUFXLEVBQUUsSUFBSTtJQUNqQixJQUFJLEVBQUUsS0FBSyxDQUFDLFVBQVU7SUFDdEIsU0FBUyxFQUFFLEtBQUs7Q0FDakIsQ0FBQyxDQUFDO0FBQ0wsTUFBTSxPQUFPLEdBQUcsSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUN0RCxNQUFNLE9BQU8sR0FBRyxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDMUQsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDdEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sT0FBTyxHQUFHLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUMxRCxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FB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SSxFQUFFLElBQUksQ0FBQyxJQUFJO2FBQ2hCLENBQUM7UUFDSixDQUFDO0tBQUE7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFRIUkVFIGZyb20gJ3RocmVlJztcclxuaW1wb3J0IHsgQnVmZmVyR2VvbWV0cnkgfSBmcm9tICd0aHJlZSc7XHJcbmltcG9ydCB7IFNUTExvYWRlciB9IGZyb20gJ3RocmVlL2V4YW1wbGVzL2pzbS9sb2FkZXJzL1NUTExvYWRlcic7XHJcblxyXG5jb25zdCBNQVRFUklBTF8wID0gKGNvbG9yID0gMHhmZmZmZmYpID0+XHJcbiAgbmV3IFRIUkVFLk1lc2hQaG9uZ01hdGVyaWFsKHtcclxuICAgIGNvbG9yLFxyXG4gICAgZmxhdFNoYWRpbmc6IHRydWUsXHJcbiAgICBzaWRlOiBUSFJFRS5Eb3VibGVTaWRlLFxyXG4gICAgd2lyZWZyYW1lOiBmYWxzZSxcclxuICB9KTtcclxuY29uc3QgTElHSFRfMCA9IG5ldyBUSFJFRS5BbWJpZW50TGlnaHQoMHhmZmZmZmYsIDAuMyk7XHJcbmNvbnN0IExJR0hUXzEgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMC4yKTtcclxuTElHSFRfMS5wb3NpdGlvbi5zZXQoLTEwMCwgLTEwMCwgMTAwKTtcclxuTElHSFRfMS5sb29rQXQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCkpO1xyXG5jb25zdCBMSUdIVF8yID0gbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIDAuMik7XHJcbkxJR0hUXzIucG9zaXRpb24uc2V0KDEwMCwgMCwgMCk7XHJcbkxJR0hUXzIubG9va0F0KG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApKTtcclxuY29uc3QgTElHSFRfMyA9IG5ldyBUSFJFRS5EaXJlY3Rpb25hbExpZ2h0KDB4ZmZmZmZmLCAwLjIpO1xyXG5MSUdIVF8zLnBvc2l0aW9uLnNldCgtMjAsIDEwMCwgMCk7XHJcbkxJR0hUXzMubG9va0F0KG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApKTtcclxuY29uc3QgTElHSFRfNCA9IG5ldyBUSFJFRS5EaXJlY3Rpb25hbExpZ2h0KDB4ZmZmZmZmLCAwLjQpO1xyXG5MSUdIVF80LnBvc2l0aW9uLnNldCg1MCwgNTAsIDApO1xyXG5MSUdIVF80Lmxvb2tBdChuZXcgVEhSRUUuVmVjdG9yMygtMTAwLCAwLCAwKSk7XHJcblxyXG5leHBvcnQgdHlwZSBTbmFwU2hvdFJlc3VsdCA9IHtcclxuICBpbWFnZXM6IHN0cmluZ1tdO1xyXG4gIHNpZGVMZW5ndGg6IG51bWJlcjtcclxuICBwcG1tOiBudW1iZXI7XHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgU3RsU25hcHNob3RTZXJ2aWNlIHtcclxuICBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XHJcbiAgcmVuZGVyZXI6IFRIUkVFLldlYkdMUmVuZGVyZXI7XHJcbiAgY2FtZXJhOiBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYTtcclxuICBzdGxMb2FkZXI6IFNUTExvYWRlciA9IG5ldyBTVExMb2FkZXIoKTtcclxuICBzY2VuZTogVEhSRUUuU2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcclxuICBvYmplY3RzID0gbmV3IFRIUkVFLkdyb3VwKCk7XHJcbiAgbGlnaHRzID0gbmV3IFRIUkVFLkdyb3VwKCk7XHJcbiAgZ2VvbWV0cnk6IEJ1ZmZlckdlb21ldHJ5O1xyXG4gIHNpZGVMZW5ndGggPSAwO1xyXG4gIGRpc3RhbmNlID0gMTA7XHJcbiAgY2VudGVyOiBUSFJFRS5WZWN0b3IzO1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZmlsZTogRmlsZSB8IEFycmF5QnVmZmVyLCBwcml2YXRlIHBwbW06IG51bWJlcikge31cclxuICBhc3luYyByZWFkKCk6IFByb21pc2U8QXJyYXlCdWZmZXI+IHtcclxuICAgIGlmICh0aGlzLmZpbGUgaW5zdGFuY2VvZiBGaWxlKSB7XHJcbiAgICAgIHRoaXMuZmlsZSA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiByZXNvbHZlKHJlYWRlci5yZXN1bHQgYXMgQXJyYXlCdWZmZXIpO1xyXG4gICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcih0aGlzLmZpbGUgYXMgRmlsZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuZmlsZSBhcyBBcnJheUJ1ZmZlcjtcclxuICB9XHJcbiAgYXN5bmMgc25hcHNob3QoZmlsZVNhdmU/OiAoZGF0YTogc3RyaW5nKSA9PiB2b2lkKTogUHJvbWlzZTxTbmFwU2hvdFJlc3VsdD4ge1xyXG4gICAgdGhpcy5pbml0KGF3YWl0IHRoaXMucmVhZCgpKTtcclxuICAgIHJldHVybiBhd2FpdCB0aGlzLnNob3QoZmlsZVNhdmUpO1xyXG4gIH1cclxuICBwcml2YXRlIGluaXQoZGF0YTogQXJyYXlCdWZmZXIpIHtcclxuICAgIHRoaXMuZ2VvbWV0cnkgPSB0aGlzLnN0bExvYWRlci5wYXJzZShkYXRhKTtcclxuICAgIHRoaXMuZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nQm94KCk7XHJcbiAgICB0aGlzLmdlb21ldHJ5LmNlbnRlcigpO1xyXG4gICAgdGhpcy5nZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTtcclxuICAgIGNvbnN0IHsgeCwgeSwgeiB9ID0gdGhpcy5nZW9tZXRyeS5ib3VuZGluZ0JveC5tYXg7XHJcbiAgICB0aGlzLmRpc3RhbmNlID0gTWF0aC5tYXgoeCwgeSwgeikgKiAxMDtcclxuICAgIGNvbnN0IHsgY2VudGVyLCByYWRpdXMgfSA9IHRoaXMuZ2VvbWV0cnkuYm91bmRpbmdTcGhlcmU7XHJcbiAgICBjb25zb2xlLmRlYnVnKGNlbnRlciwgcmFkaXVzLCB4LCB5LCB6KTtcclxuXHJcbiAgICB0aGlzLmNlbnRlciA9IGNlbnRlcjtcclxuICAgIHRoaXMuc2lkZUxlbmd0aCA9IHJhZGl1cyAqIDI7XHJcbiAgICB0aGlzLmNhbnZhcy5oZWlnaHQgPSB0aGlzLmNhbnZhcy53aWR0aCA9IHRoaXMuc2lkZUxlbmd0aCAqIHRoaXMucHBtbTtcclxuICAgIHRoaXMucmVuZGVyZXIgPSBuZXcgVEhSRUUuV2ViR0xSZW5kZXJlcih7XHJcbiAgICAgIGFscGhhOiB0cnVlLFxyXG4gICAgICBhbnRpYWxpYXM6IHRydWUsXHJcbiAgICAgIGNhbnZhczogdGhpcy5jYW52YXMsXHJcbiAgICB9KTtcclxuICAgIHRoaXMuY2FtZXJhID0gbmV3IFRIUkVFLlBlcnNwZWN0aXZlQ2FtZXJhKDE1LCAxKTtcclxuICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnNldCgwLCB0aGlzLmRpc3RhbmNlLCAwKTtcclxuICAgIHRoaXMuY2FtZXJhLmxvb2tBdChjZW50ZXIpO1xyXG4gICAgdGhpcy5saWdodHMuYWRkKExJR0hUXzAsIExJR0hUXzEsIExJR0hUXzIsIExJR0hUXzMpO1xyXG4gICAgdGhpcy5jYW1lcmEuYWRkKExJR0hUXzQpO1xyXG4gICAgY29uc3QgbWVzaCA9IG5ldyBUSFJFRS5NZXNoKHRoaXMuZ2VvbWV0cnksIE1BVEVSSUFMXzAoMHhmZmZmZmYpKTtcclxuICAgIG1lc2gucm90YXRlT25Xb3JsZEF4aXMobmV3IFRIUkVFLlZlY3RvcjMoMCwgMSwgMCksIC1NYXRoLlBJIC8gMik7XHJcbiAgICB0aGlzLm9iamVjdHMuYWRkKG1lc2gpO1xyXG4gICAgdGhpcy5zY2VuZS5hZGQodGhpcy5jYW1lcmEsIHRoaXMub2JqZWN0cywgdGhpcy5saWdodHMpO1xyXG4gICAgdGhpcy5yZW5kZXJlci5yZW5kZXIodGhpcy5zY2VuZSwgdGhpcy5jYW1lcmEpO1xyXG4gIH1cclxuICBwcml2YXRlIGFzeW5jIHNob3QoZmlsZVNhdmU/OiAoZGF0YTogc3RyaW5nKSA9PiB2b2lkKSB7XHJcbiAgICBjb25zdCBpbWFnZXMgPSBbXTtcclxuICAgIGNvbnN0IHBvc2l0aW9ucyA9IFtcclxuICAgICAgWzAsIHRoaXMuZGlzdGFuY2UsIDBdLFxyXG4gICAgICBbMCwgLXRoaXMuZGlzdGFuY2UsIDBdLFxyXG4gICAgICBbdGhpcy5kaXN0YW5jZSwgMCwgMF0sXHJcbiAgICAgIFstdGhpcy5kaXN0YW5jZSwgMCwgMF0sXHJcbiAgICAgIFswLCAwLCB0aGlzLmRpc3RhbmNlXSxcclxuICAgICAgWzAsIDAsIC10aGlzLmRpc3RhbmNlXSxcclxuICAgIF07XHJcblxyXG4gICAgZm9yIChjb25zdCBwIG9mIHBvc2l0aW9ucykge1xyXG4gICAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi5zZXQocFswXSwgcFsxXSwgcFsyXSk7XHJcbiAgICAgIHRoaXMuY2FtZXJhLmxvb2tBdCh0aGlzLmNlbnRlcik7XHJcbiAgICAgIHRoaXMuY2FtZXJhLnVwLnNldCgwLCAwLCBwLnNvbWUoKHgpID0+IHggPiAwKSA/IC0xIDogMSk7XHJcbiAgICAgIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTtcclxuICAgICAgdGhpcy5yZW5kZXJlci5yZW5kZXIodGhpcy5zY2VuZSwgdGhpcy5jYW1lcmEpO1xyXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiBzZXRUaW1lb3V0KHJlc29sdmUpKTtcclxuICAgICAgY29uc3QgZGF0YVVSTCA9IHRoaXMuY2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyk7XHJcbiAgICAgIGltYWdlcy5wdXNoKGRhdGFVUkwpO1xyXG4gICAgICBpZiAoZmlsZVNhdmUpIHtcclxuICAgICAgICBmaWxlU2F2ZShkYXRhVVJMLnJlcGxhY2UoL15kYXRhOmltYWdlXFwvXFx3KztiYXNlNjQsLywgJycpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgaW1hZ2VzLFxyXG4gICAgICBzaWRlTGVuZ3RoOiB0aGlzLnNpZGVMZW5ndGgsXHJcbiAgICAgIHBwbW06IHRoaXMucHBtbSxcclxuICAgIH07XHJcbiAgfVxyXG59XHJcbiJdfQ==