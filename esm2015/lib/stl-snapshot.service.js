import { __awaiter } from "tslib";
import * as THREE from 'three';
import { STLLoader } from 'three/examples/jsm/loaders/STLLoader';
const MATERIAL_0 = (color = 0xffffff) => new THREE.MeshPhongMaterial({
    color,
    flatShading: true,
    side: THREE.DoubleSide,
    wireframe: false,
});
const LIGHT_0 = new THREE.AmbientLight(0xffffff, 0.3);
const LIGHT_1 = new THREE.DirectionalLight(0xffffff, 0.2);
LIGHT_1.position.set(-100, -100, 100);
LIGHT_1.lookAt(new THREE.Vector3(0, 0, 0));
const LIGHT_2 = new THREE.DirectionalLight(0xffffff, 0.2);
LIGHT_2.position.set(100, 0, 0);
LIGHT_2.lookAt(new THREE.Vector3(0, 0, 0));
const LIGHT_3 = new THREE.DirectionalLight(0xffffff, 0.2);
LIGHT_3.position.set(-20, 100, 0);
LIGHT_3.lookAt(new THREE.Vector3(0, 0, 0));
const LIGHT_4 = new THREE.DirectionalLight(0xffffff, 0.4);
LIGHT_4.position.set(50, 50, 0);
LIGHT_4.lookAt(new THREE.Vector3(-100, 0, 0));
export class StlSnapshotService {
    constructor(file, ppmm) {
        this.file = file;
        this.ppmm = ppmm;
        this.canvas = document.createElement('canvas');
        this.renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: true,
            canvas: this.canvas,
        });
        this.stlLoader = new STLLoader();
        this.scene = new THREE.Scene();
        this.objects = new THREE.Group();
        this.lights = new THREE.Group();
        this.sideLength = 0;
    }
    read() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.file instanceof File) {
                this.file = yield new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsArrayBuffer(this.file);
                });
            }
            return this.file;
        });
    }
    snapshot(fileSave) {
        return __awaiter(this, void 0, void 0, function* () {
            this.init(yield this.read());
            return this.shot(fileSave);
        });
    }
    init(data) {
        this.geometry = this.stlLoader.parse(data);
        this.geometry.computeBoundingBox();
        this.geometry.center();
        this.geometry.computeBoundingSphere();
        const { max, min } = this.geometry.boundingBox;
        this.sideLength = Math.ceil(Math.max(max.x - min.x, max.y - min.y, max.z - min.z));
        this.canvas.height = this.canvas.width = this.sideLength;
        this.camera = new THREE.OrthographicCamera(-this.sideLength / 2, this.sideLength / 2, this.sideLength / 2, -this.sideLength / 2, 1, 1000);
        this.camera.position.set(0, 0, 100);
        this.camera.lookAt(new THREE.Vector3(0, 0, 0));
        this.lights.add(LIGHT_0, LIGHT_1, LIGHT_2, LIGHT_3);
        this.camera.add(LIGHT_4);
        this.objects.add(new THREE.Mesh(this.geometry, MATERIAL_0(0xffffff)));
        this.scene.add(this.camera, this.objects, this.lights);
    }
    shot(fileSave) {
        const images = [];
        const positions = [
            [0, 0, 100, -1, 0, 0],
            [0, 0, -100, 1, 0, 0],
            [0, 100, 50, 0, 0, -1],
            [100, 0, 50, 0, 0, -1],
            [0, 100, -50, 0, 0, 1],
            [100, 0, -50, 0, 0, 1],
        ];
        for (const p of positions) {
            this.camera.position.set(p[0], p[1], p[2]);
            this.camera.up.set(p[3], p[4], p[5]);
            this.camera.lookAt(new THREE.Vector3(0, 0, 0));
            this.camera.updateProjectionMatrix();
            this.renderer.render(this.scene, this.camera);
            const dataURL = this.canvas.toDataURL('image/png');
            images.push(dataURL);
            if (fileSave) {
                fileSave(dataURL.replace(/^data:image\/\w+;base64,/, ''));
            }
        }
        return {
            images,
            sideLength: this.sideLength,
            ppmm: this.ppmm,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RsLXNuYXBzaG90LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9hbmd1bGFyLXN0bC1tb2RlbC12aWV3ZXIvc3JjL2xpYi9zdGwtc25hcHNob3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFFL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBRWpFLE1BQU0sVUFBVSxHQUFHLENBQUMsS0FBSyxHQUFHLFFBQVEsRUFBRSxFQUFFLENBQ3RDLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDO0lBQzFCLEtBQUs7SUFDTCxXQUFXLEVBQUUsSUFBSTtJQUNqQixJQUFJLEVBQUUsS0FBSyxDQUFDLFVBQVU7SUFDdEIsU0FBUyxFQUFFLEtBQUs7Q0FDakIsQ0FBQyxDQUFDO0FBQ0wsTUFBTSxPQUFPLEdBQUcsSUFBSSxLQUFLLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUN0RCxNQUFNLE9BQU8sR0FBRyxJQUFJLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDMUQsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDdEMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sT0FBTyxHQUFHLElBQUksS0FBSyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztBQUMxRCxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FB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QUFDLENBQUMsQ0FBQztZQUMzQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUNyQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUM5QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNuRCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3JCLElBQUksUUFBUSxFQUFFO2dCQUNaLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLDBCQUEwQixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDM0Q7U0FDRjtRQUNELE9BQU87WUFDTCxNQUFNO1lBQ04sVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO1lBQzNCLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtTQUNoQixDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnO1xyXG5pbXBvcnQgeyBCdWZmZXJHZW9tZXRyeSB9IGZyb20gJ3RocmVlJztcclxuaW1wb3J0IHsgU1RMTG9hZGVyIH0gZnJvbSAndGhyZWUvZXhhbXBsZXMvanNtL2xvYWRlcnMvU1RMTG9hZGVyJztcclxuXHJcbmNvbnN0IE1BVEVSSUFMXzAgPSAoY29sb3IgPSAweGZmZmZmZikgPT5cclxuICBuZXcgVEhSRUUuTWVzaFBob25nTWF0ZXJpYWwoe1xyXG4gICAgY29sb3IsXHJcbiAgICBmbGF0U2hhZGluZzogdHJ1ZSxcclxuICAgIHNpZGU6IFRIUkVFLkRvdWJsZVNpZGUsXHJcbiAgICB3aXJlZnJhbWU6IGZhbHNlLFxyXG4gIH0pO1xyXG5jb25zdCBMSUdIVF8wID0gbmV3IFRIUkVFLkFtYmllbnRMaWdodCgweGZmZmZmZiwgMC4zKTtcclxuY29uc3QgTElHSFRfMSA9IG5ldyBUSFJFRS5EaXJlY3Rpb25hbExpZ2h0KDB4ZmZmZmZmLCAwLjIpO1xyXG5MSUdIVF8xLnBvc2l0aW9uLnNldCgtMTAwLCAtMTAwLCAxMDApO1xyXG5MSUdIVF8xLmxvb2tBdChuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSk7XHJcbmNvbnN0IExJR0hUXzIgPSBuZXcgVEhSRUUuRGlyZWN0aW9uYWxMaWdodCgweGZmZmZmZiwgMC4yKTtcclxuTElHSFRfMi5wb3NpdGlvbi5zZXQoMTAwLCAwLCAwKTtcclxuTElHSFRfMi5sb29rQXQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCkpO1xyXG5jb25zdCBMSUdIVF8zID0gbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIDAuMik7XHJcbkxJR0hUXzMucG9zaXRpb24uc2V0KC0yMCwgMTAwLCAwKTtcclxuTElHSFRfMy5sb29rQXQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCkpO1xyXG5jb25zdCBMSUdIVF80ID0gbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIDAuNCk7XHJcbkxJR0hUXzQucG9zaXRpb24uc2V0KDUwLCA1MCwgMCk7XHJcbkxJR0hUXzQubG9va0F0KG5ldyBUSFJFRS5WZWN0b3IzKC0xMDAsIDAsIDApKTtcclxuXHJcbmV4cG9ydCB0eXBlIFNuYXBTaG90UmVzdWx0ID0ge1xyXG4gIGltYWdlczogc3RyaW5nW107XHJcbiAgc2lkZUxlbmd0aDogbnVtYmVyO1xyXG4gIHBwbW06IG51bWJlcjtcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBTdGxTbmFwc2hvdFNlcnZpY2Uge1xyXG4gIGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcclxuICByZW5kZXJlcjogVEhSRUUuV2ViR0xSZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHtcclxuICAgIGFscGhhOiB0cnVlLFxyXG4gICAgYW50aWFsaWFzOiB0cnVlLFxyXG4gICAgY2FudmFzOiB0aGlzLmNhbnZhcyxcclxuICB9KTtcclxuICBjYW1lcmE6IFRIUkVFLk9ydGhvZ3JhcGhpY0NhbWVyYTtcclxuICBzdGxMb2FkZXI6IFNUTExvYWRlciA9IG5ldyBTVExMb2FkZXIoKTtcclxuICBzY2VuZTogVEhSRUUuU2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcclxuICBvYmplY3RzID0gbmV3IFRIUkVFLkdyb3VwKCk7XHJcbiAgbGlnaHRzID0gbmV3IFRIUkVFLkdyb3VwKCk7XHJcbiAgZ2VvbWV0cnk6IEJ1ZmZlckdlb21ldHJ5O1xyXG4gIHNpZGVMZW5ndGggPSAwO1xyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZmlsZTogRmlsZSB8IEFycmF5QnVmZmVyLCBwcml2YXRlIHBwbW06IG51bWJlcikge31cclxuICBhc3luYyByZWFkKCk6IFByb21pc2U8QXJyYXlCdWZmZXI+IHtcclxuICAgIGlmICh0aGlzLmZpbGUgaW5zdGFuY2VvZiBGaWxlKSB7XHJcbiAgICAgIHRoaXMuZmlsZSA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xyXG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoKSA9PiByZXNvbHZlKHJlYWRlci5yZXN1bHQgYXMgQXJyYXlCdWZmZXIpO1xyXG4gICAgICAgIHJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcih0aGlzLmZpbGUgYXMgRmlsZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuZmlsZSBhcyBBcnJheUJ1ZmZlcjtcclxuICB9XHJcbiAgYXN5bmMgc25hcHNob3QoZmlsZVNhdmU/OiAoZGF0YTogc3RyaW5nKSA9PiB2b2lkKTogUHJvbWlzZTxTbmFwU2hvdFJlc3VsdD4ge1xyXG4gICAgdGhpcy5pbml0KGF3YWl0IHRoaXMucmVhZCgpKTtcclxuICAgIHJldHVybiB0aGlzLnNob3QoZmlsZVNhdmUpO1xyXG4gIH1cclxuICBwcml2YXRlIGluaXQoZGF0YTogQXJyYXlCdWZmZXIpIHtcclxuICAgIHRoaXMuZ2VvbWV0cnkgPSB0aGlzLnN0bExvYWRlci5wYXJzZShkYXRhKTtcclxuICAgIHRoaXMuZ2VvbWV0cnkuY29tcHV0ZUJvdW5kaW5nQm94KCk7XHJcbiAgICB0aGlzLmdlb21ldHJ5LmNlbnRlcigpO1xyXG4gICAgdGhpcy5nZW9tZXRyeS5jb21wdXRlQm91bmRpbmdTcGhlcmUoKTtcclxuICAgIGNvbnN0IHsgbWF4LCBtaW4gfSA9IHRoaXMuZ2VvbWV0cnkuYm91bmRpbmdCb3g7XHJcbiAgICB0aGlzLnNpZGVMZW5ndGggPSBNYXRoLmNlaWwoXHJcbiAgICAgIE1hdGgubWF4KG1heC54IC0gbWluLngsIG1heC55IC0gbWluLnksIG1heC56IC0gbWluLnopXHJcbiAgICApO1xyXG4gICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gdGhpcy5jYW52YXMud2lkdGggPSB0aGlzLnNpZGVMZW5ndGg7XHJcbiAgICB0aGlzLmNhbWVyYSA9IG5ldyBUSFJFRS5PcnRob2dyYXBoaWNDYW1lcmEoXHJcbiAgICAgIC10aGlzLnNpZGVMZW5ndGggLyAyLFxyXG4gICAgICB0aGlzLnNpZGVMZW5ndGggLyAyLFxyXG4gICAgICB0aGlzLnNpZGVMZW5ndGggLyAyLFxyXG4gICAgICAtdGhpcy5zaWRlTGVuZ3RoIC8gMixcclxuICAgICAgMSxcclxuICAgICAgMTAwMFxyXG4gICAgKTtcclxuICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnNldCgwLCAwLCAxMDApO1xyXG4gICAgdGhpcy5jYW1lcmEubG9va0F0KG5ldyBUSFJFRS5WZWN0b3IzKDAsIDAsIDApKTtcclxuICAgIHRoaXMubGlnaHRzLmFkZChMSUdIVF8wLCBMSUdIVF8xLCBMSUdIVF8yLCBMSUdIVF8zKTtcclxuICAgIHRoaXMuY2FtZXJhLmFkZChMSUdIVF80KTtcclxuICAgIHRoaXMub2JqZWN0cy5hZGQobmV3IFRIUkVFLk1lc2godGhpcy5nZW9tZXRyeSwgTUFURVJJQUxfMCgweGZmZmZmZikpKTtcclxuICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMuY2FtZXJhLCB0aGlzLm9iamVjdHMsIHRoaXMubGlnaHRzKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzaG90KGZpbGVTYXZlPzogKGRhdGE6IHN0cmluZykgPT4gdm9pZCkge1xyXG4gICAgY29uc3QgaW1hZ2VzID0gW107XHJcbiAgICBjb25zdCBwb3NpdGlvbnMgPSBbXHJcbiAgICAgIFswLCAwLCAxMDAsIC0xLCAwLCAwXSxcclxuICAgICAgWzAsIDAsIC0xMDAsIDEsIDAsIDBdLFxyXG4gICAgICBbMCwgMTAwLCA1MCwgMCwgMCwgLTFdLFxyXG4gICAgICBbMTAwLCAwLCA1MCwgMCwgMCwgLTFdLFxyXG4gICAgICBbMCwgMTAwLCAtNTAsIDAsIDAsIDFdLFxyXG4gICAgICBbMTAwLCAwLCAtNTAsIDAsIDAsIDFdLFxyXG4gICAgXTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IHAgb2YgcG9zaXRpb25zKSB7XHJcbiAgICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnNldChwWzBdLCBwWzFdLCBwWzJdKTtcclxuICAgICAgdGhpcy5jYW1lcmEudXAuc2V0KHBbM10sIHBbNF0sIHBbNV0pO1xyXG4gICAgICB0aGlzLmNhbWVyYS5sb29rQXQobmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCkpO1xyXG4gICAgICB0aGlzLmNhbWVyYS51cGRhdGVQcm9qZWN0aW9uTWF0cml4KCk7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc2NlbmUsIHRoaXMuY2FtZXJhKTtcclxuICAgICAgY29uc3QgZGF0YVVSTCA9IHRoaXMuY2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyk7XHJcbiAgICAgIGltYWdlcy5wdXNoKGRhdGFVUkwpO1xyXG4gICAgICBpZiAoZmlsZVNhdmUpIHtcclxuICAgICAgICBmaWxlU2F2ZShkYXRhVVJMLnJlcGxhY2UoL15kYXRhOmltYWdlXFwvXFx3KztiYXNlNjQsLywgJycpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgaW1hZ2VzLFxyXG4gICAgICBzaWRlTGVuZ3RoOiB0aGlzLnNpZGVMZW5ndGgsXHJcbiAgICAgIHBwbW06IHRoaXMucHBtbSxcclxuICAgIH07XHJcbiAgfVxyXG59XHJcbiJdfQ==