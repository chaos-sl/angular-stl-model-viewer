import { __awaiter } from "tslib";
import { Component, ElementRef, EventEmitter, Input, NgZone, Output, ChangeDetectionStrategy, ChangeDetectorRef, } from '@angular/core';
import * as THREE from 'three';
import { STLLoader } from 'three/examples/jsm/loaders/STLLoader';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';
import { LightProbeGenerator } from 'three/examples/jsm/lights/LightProbeGenerator.js';
export var RotateDirection;
(function (RotateDirection) {
    RotateDirection[RotateDirection["up"] = 0] = "up";
    RotateDirection[RotateDirection["right"] = 1] = "right";
    RotateDirection[RotateDirection["down"] = 2] = "down";
    RotateDirection[RotateDirection["left"] = 3] = "left";
    RotateDirection[RotateDirection["none"] = 4] = "none";
})(RotateDirection || (RotateDirection = {}));
export var ZoomDirection;
(function (ZoomDirection) {
    ZoomDirection[ZoomDirection["in"] = 0] = "in";
    ZoomDirection[ZoomDirection["out"] = 1] = "out";
})(ZoomDirection || (ZoomDirection = {}));
const defaultMeshOptions = {
    castShadow: true,
    position: new THREE.Vector3(0, 0, 0),
    receiveShadow: true,
    scale: new THREE.Vector3(1, 1, 1),
};
function isWebGLAvailable() {
    try {
        const canvas = document.createElement('canvas');
        return !!(window.WebGLRenderingContext &&
            (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
    }
    catch (e) {
        return false;
    }
}
export class StlModelViewerComponent {
    constructor(cdr, eleRef, ngZone) {
        this.cdr = cdr;
        this.eleRef = eleRef;
        this.ngZone = ngZone;
        this._models = [];
        this.hasControls = true;
        this.camera = new THREE.PerspectiveCamera(15, window.innerWidth / window.innerHeight);
        this.cameraTarget = new THREE.Vector3(0, 0, 0);
        this.light = new THREE.DirectionalLight(0xffffff, 1);
        this.material = new THREE.MeshPhongMaterial({
            color: 0xc4c4c4,
            shininess: 100,
            specular: 0x111111,
        });
        this.scene = new THREE.Scene();
        this.renderer = new THREE.WebGLRenderer({
            antialias: true,
        });
        this.controls = null;
        this.meshOptions = [];
        this.rendered = new EventEmitter();
        this.xzAngle = 0; // Azimuthal angle
        this.yzAngle = 0; // Polar angle
        this.distance = 10; // PerspectiveCamera distance
        this.zoomFactor = 0; // OrthographicCamera zoom
        this.hasWebGL = isWebGLAvailable();
        this.meshGroup = new THREE.Object3D();
        this.isRendered = false;
        this.showStlModel = true;
        this.stlLoader = new STLLoader();
        this.lightProbe = new THREE.LightProbe(undefined, 1);
        this.render = () => {
            this.renderer.render(this.scene, this.camera);
        };
        this.onWindowResize = () => {
            this.setSizes();
            this.render();
        };
        this.cdr.detach();
        // default light position
        this.light.position.set(10, 10, 10);
        // default camera position
        this.camera.position.set(0, this.distance, 0);
        this.camera.lookAt(0, 0, 0);
        // default scene background
        this.scene.background = new THREE.Color(0xdcdcdc);
        new THREE.CubeTextureLoader().load(this.genCubeUrls('assets/', '.png'), (cubeTexture) => {
            cubeTexture.encoding = THREE.sRGBEncoding;
            this.lightProbe.copy(LightProbeGenerator.fromCubeTexture(cubeTexture));
            // this.scene.background = cubeTexture;
            this.texture = cubeTexture;
            this.material = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                metalness: 0.4,
                roughness: 0.2,
                envMap: cubeTexture,
                envMapIntensity: 1,
            });
        });
        // default renderer options
        this.renderer.setPixelRatio(window.devicePixelRatio);
        this.renderer.shadowMap.enabled = true;
    }
    set stlModels(models) {
        this._models = models;
        this.refreshMeshGroup();
    }
    get stlModels() {
        return this._models;
    }
    // envmap
    genCubeUrls(prefix, postfix) {
        return [
            prefix + 'bg' + postfix,
            prefix + 'bg' + postfix,
            prefix + 'bg' + postfix,
            prefix + 'bg' + postfix,
            prefix + 'bg' + postfix,
            prefix + 'bg' + postfix,
        ];
    }
    ngOnInit() {
        if (!this.hasWebGL) {
            console.error('stl-model-viewer: Seems like your system does not support webgl.');
            return;
        }
        this.ngZone.runOutsideAngular(() => {
            this.init();
        });
    }
    ngOnDestroy() {
        window.removeEventListener('resize', this.onWindowResize, false);
        this.meshGroup.remove();
        if (this.renderer) {
            this.renderer.renderLists.dispose();
            this.renderer.dispose();
        }
        if (this.camera) {
            this.camera.remove();
        }
        if (this.light) {
            this.light.remove();
        }
        if (this.material) {
            this.material.dispose();
        }
        if (this.controls) {
            this.controls.removeEventListener('change', this.render);
            this.controls.dispose();
        }
        if (this.scene) {
            this.scene.children.forEach((child) => {
                this.scene.remove(child);
            });
            this.scene.dispose();
        }
    }
    zoom(direction, stepCount = 1) {
        if (this.camera instanceof THREE.PerspectiveCamera) {
            switch (direction) {
                case ZoomDirection.in:
                    this.distance += stepCount;
                    break;
                case ZoomDirection.out:
                    this.distance -= stepCount;
                    break;
            }
            this.distance = this.distance < 0 ? 0 : this.distance;
        }
        this.rotate(RotateDirection.none);
    }
    rotate(direction, stepCount = 1) {
        let step = 0;
        switch (direction) {
            case RotateDirection.up:
                step = 0.1;
                break;
            case RotateDirection.right:
                this.xzAngle += 0.1;
                break;
            case RotateDirection.down:
                step = -0.1;
                break;
            case RotateDirection.left:
                this.xzAngle -= 0.1;
                break;
            default:
                break;
        }
        if (Math.abs(this.yzAngle + step * stepCount) < Math.PI / 2) {
            this.yzAngle += step;
        }
        else {
            this.yzAngle = step > 0 ? Math.PI / 2 : -Math.PI / 2;
        }
        this.camera.position.x =
            this.distance * Math.cos(this.yzAngle) * Math.cos(this.xzAngle);
        this.camera.position.z =
            this.distance * Math.cos(this.yzAngle) * Math.sin(this.xzAngle);
        this.camera.position.y = this.distance * Math.sin(this.yzAngle);
        this.camera.lookAt(0, 0, 0);
        this.render();
    }
    init() {
        return __awaiter(this, void 0, void 0, function* () {
            this.scene.add(this.lightProbe);
            this.camera.add(this.light);
            this.scene.add(this.camera);
            // use default controls
            if (this.hasControls && !this.controls) {
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableZoom = true;
                this.controls.addEventListener('change', this.render);
            }
            window.addEventListener('resize', this.onWindowResize, false);
            yield this.refreshMeshGroup();
            this.scene.add(this.meshGroup);
            this.eleRef.nativeElement.appendChild(this.renderer.domElement);
            this.setSizes();
            this.render();
            this.ngZone.run(() => {
                this.isRendered = true;
                this.rendered.emit();
                this.cdr.detectChanges();
            });
        });
    }
    refreshMeshGroup() {
        return __awaiter(this, void 0, void 0, function* () {
            this.meshGroup.remove(...this.meshGroup.children);
            const meshCreations = this.stlModels.map((modelPath, index) => {
                return this.createMesh(modelPath, this.meshOptions[index]);
            });
            const meshes = yield Promise.all(meshCreations);
            meshes.map((mesh) => this.meshGroup.add(mesh));
            this.rotate(RotateDirection.none);
        });
    }
    createMesh(path, meshOptions = {}) {
        return __awaiter(this, void 0, void 0, function* () {
            const geometry = yield this.stlLoader.loadAsync(path);
            geometry.computeBoundingBox();
            geometry.center();
            const { x, y, z } = geometry.boundingBox.max;
            this.distance = Math.max(x, y, z) * 10;
            const mesh = new THREE.Mesh(geometry, this.material);
            mesh.rotateOnWorldAxis(new THREE.Vector3(0, 1, 0), -Math.PI / 2);
            const vectorOptions = ['position', 'scale', 'up'];
            const options = Object.assign({}, defaultMeshOptions, meshOptions);
            Object.getOwnPropertyNames(options).forEach((option) => {
                if (vectorOptions.indexOf(option) > -1) {
                    const vector = options[option];
                    const meshVectorOption = mesh[option];
                    meshVectorOption.set(vector.x, vector.y, vector.z);
                }
                else {
                    mesh[option] = options[option];
                }
            });
            return mesh;
        });
    }
    setSizes() {
        const width = this.eleRef.nativeElement.offsetWidth;
        const height = this.eleRef.nativeElement.offsetHeight;
        this.camera.aspect = width / height;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(width, height);
    }
}
StlModelViewerComponent.decorators = [
    { type: Component, args: [{
                changeDetection: ChangeDetectionStrategy.OnPush,
                selector: 'stl-model-viewer',
                template: '',
                styles: [`
      :host {
        width: 100%
        height: 100%
        display: block
      }
    `]
            },] }
];
StlModelViewerComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: ElementRef },
    { type: NgZone }
];
StlModelViewerComponent.propDecorators = {
    stlModels: [{ type: Input }],
    hasControls: [{ type: Input }],
    camera: [{ type: Input }],
    cameraTarget: [{ type: Input }],
    light: [{ type: Input }],
    material: [{ type: Input }],
    scene: [{ type: Input }],
    renderer: [{ type: Input }],
    controls: [{ type: Input }],
    meshOptions: [{ type: Input }],
    rendered: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1zdGwtbW9kZWwtdmlld2VyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItc3RsLW1vZGVsLXZpZXdlci9zcmMvbGliL2FuZ3VsYXItc3RsLW1vZGVsLXZpZXdlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUdOLE1BQU0sRUFDTix1QkFBdUIsRUFDdkIsaUJBQWlCLEdBQ2xCLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBRS9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUNqRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDMUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFHdkYsTUFBTSxDQUFOLElBQVksZUFNWDtBQU5ELFdBQVksZUFBZTtJQUN6QixpREFBRSxDQUFBO0lBQ0YsdURBQUssQ0FBQTtJQUNMLHFEQUFJLENBQUE7SUFDSixxREFBSSxDQUFBO0lBQ0oscURBQUksQ0FBQTtBQUNOLENBQUMsRUFOVyxlQUFlLEtBQWYsZUFBZSxRQU0xQjtBQUNELE1BQU0sQ0FBTixJQUFZLGFBR1g7QUFIRCxXQUFZLGFBQWE7SUFDdkIsNkNBQUUsQ0FBQTtJQUNGLCtDQUFHLENBQUE7QUFDTCxDQUFDLEVBSFcsYUFBYSxLQUFiLGFBQWEsUUFHeEI7QUFXRCxNQUFNLGtCQUFrQixHQUFHO0lBQ3pCLFVBQVUsRUFBRSxJQUFJO0lBQ2hCLFFBQVEsRUFBRSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDcEMsYUFBYSxFQUFFLElBQUk7SUFDbkIsS0FB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aUI7WUFSakIsVUFBVTtZQUdWLE1BQU07Ozt3QkF1RUwsS0FBSzswQkFPTCxLQUFLO3FCQUNMLEtBQUs7MkJBS0wsS0FBSztvQkFDTCxLQUFLO3VCQUNMLEtBQUs7b0JBS0wsS0FBSzt1QkFDTCxLQUFLO3VCQUdMLEtBQUs7MEJBQ0wsS0FBSzt1QkFFTCxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBDb21wb25lbnQsXHJcbiAgRWxlbWVudFJlZixcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgSW5wdXQsXHJcbiAgTmdab25lLFxyXG4gIE9uRGVzdHJveSxcclxuICBPbkluaXQsXHJcbiAgT3V0cHV0LFxyXG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxyXG4gIENoYW5nZURldGVjdG9yUmVmLFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0ICogYXMgVEhSRUUgZnJvbSAndGhyZWUnO1xyXG5cclxuaW1wb3J0IHsgU1RMTG9hZGVyIH0gZnJvbSAndGhyZWUvZXhhbXBsZXMvanNtL2xvYWRlcnMvU1RMTG9hZGVyJztcclxuaW1wb3J0IHsgT3JiaXRDb250cm9scyB9IGZyb20gJ3RocmVlL2V4YW1wbGVzL2pzbS9jb250cm9scy9PcmJpdENvbnRyb2xzJztcclxuaW1wb3J0IHsgTGlnaHRQcm9iZUdlbmVyYXRvciB9IGZyb20gJ3RocmVlL2V4YW1wbGVzL2pzbS9saWdodHMvTGlnaHRQcm9iZUdlbmVyYXRvci5qcyc7XHJcbmltcG9ydCB7IFZlY3RvcjMgfSBmcm9tICd0aHJlZSc7XHJcblxyXG5leHBvcnQgZW51bSBSb3RhdGVEaXJlY3Rpb24ge1xyXG4gIHVwLFxyXG4gIHJpZ2h0LFxyXG4gIGRvd24sXHJcbiAgbGVmdCxcclxuICBub25lLFxyXG59XHJcbmV4cG9ydCBlbnVtIFpvb21EaXJlY3Rpb24ge1xyXG4gIGluLFxyXG4gIG91dCxcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIE1lc2hPcHRpb25zIHtcclxuICBjYXN0U2hhZG93PzogYm9vbGVhbjtcclxuICBwb3NpdGlvbj86IFRIUkVFLlZlY3RvcjM7XHJcbiAgcmVjZWl2ZVNoYWRvdz86IGJvb2xlYW47XHJcbiAgc2NhbGU/OiBUSFJFRS5WZWN0b3IzO1xyXG4gIHVwPzogVEhSRUUuVmVjdG9yMztcclxuICB1c2VyRGF0YT86IHsgW2tleTogc3RyaW5nXTogYW55IH07XHJcbiAgdmlzaWJsZT86IGJvb2xlYW47XHJcbn1cclxuXHJcbmNvbnN0IGRlZmF1bHRNZXNoT3B0aW9ucyA9IHtcclxuICBjYXN0U2hhZG93OiB0cnVlLFxyXG4gIHBvc2l0aW9uOiBuZXcgVEhSRUUuVmVjdG9yMygwLCAwLCAwKSxcclxuICByZWNlaXZlU2hhZG93OiB0cnVlLFxyXG4gIHNjYWxlOiBuZXcgVEhSRUUuVmVjdG9yMygxLCAxLCAxKSxcclxufTtcclxuXHJcbmZ1bmN0aW9uIGlzV2ViR0xBdmFpbGFibGUoKSB7XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xyXG4gICAgcmV0dXJuICEhKFxyXG4gICAgICB3aW5kb3cuV2ViR0xSZW5kZXJpbmdDb250ZXh0ICYmXHJcbiAgICAgIChjYW52YXMuZ2V0Q29udGV4dCgnd2ViZ2wnKSB8fCBjYW52YXMuZ2V0Q29udGV4dCgnZXhwZXJpbWVudGFsLXdlYmdsJykpXHJcbiAgICApO1xyXG4gIH0gY2F0Y2ggKGUpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbn1cclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxyXG4gIHNlbGVjdG9yOiAnc3RsLW1vZGVsLXZpZXdlcicsXHJcbiAgc3R5bGVzOiBbXHJcbiAgICBgXHJcbiAgICAgIDpob3N0IHtcclxuICAgICAgICB3aWR0aDogMTAwJVxyXG4gICAgICAgIGhlaWdodDogMTAwJVxyXG4gICAgICAgIGRpc3BsYXk6IGJsb2NrXHJcbiAgICAgIH1cclxuICAgIGAsXHJcbiAgXSxcclxuICB0ZW1wbGF0ZTogJycsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTdGxNb2RlbFZpZXdlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuICBwcml2YXRlIF9tb2RlbHMgPSBbXTtcclxuICBASW5wdXQoKSBzZXQgc3RsTW9kZWxzKG1vZGVsczogc3RyaW5nW10pIHtcclxuICAgIHRoaXMuX21vZGVscyA9IG1vZGVscztcclxuICAgIHRoaXMucmVmcmVzaE1lc2hHcm91cCgpO1xyXG4gIH1cclxuICBnZXQgc3RsTW9kZWxzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX21vZGVscztcclxuICB9XHJcbiAgQElucHV0KCkgaGFzQ29udHJvbHMgPSB0cnVlO1xyXG4gIEBJbnB1dCgpIGNhbWVyYTogVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEgPSBuZXcgVEhSRUUuUGVyc3BlY3RpdmVDYW1lcmEoXHJcbiAgICAxNSxcclxuICAgIHdpbmRvdy5pbm5lcldpZHRoIC8gd2luZG93LmlubmVySGVpZ2h0XHJcbiAgKTtcclxuXHJcbiAgQElucHV0KCkgY2FtZXJhVGFyZ2V0OiBUSFJFRS5WZWN0b3IzID0gbmV3IFRIUkVFLlZlY3RvcjMoMCwgMCwgMCk7XHJcbiAgQElucHV0KCkgbGlnaHQ6IFRIUkVFLkxpZ2h0ID0gbmV3IFRIUkVFLkRpcmVjdGlvbmFsTGlnaHQoMHhmZmZmZmYsIDEpO1xyXG4gIEBJbnB1dCgpIG1hdGVyaWFsOiBUSFJFRS5NYXRlcmlhbCA9IG5ldyBUSFJFRS5NZXNoUGhvbmdNYXRlcmlhbCh7XHJcbiAgICBjb2xvcjogMHhjNGM0YzQsXHJcbiAgICBzaGluaW5lc3M6IDEwMCxcclxuICAgIHNwZWN1bGFyOiAweDExMTExMSxcclxuICB9KTtcclxuICBASW5wdXQoKSBzY2VuZTogVEhSRUUuU2NlbmUgPSBuZXcgVEhSRUUuU2NlbmUoKTtcclxuICBASW5wdXQoKSByZW5kZXJlcjogVEhSRUUuV2ViR0xSZW5kZXJlciA9IG5ldyBUSFJFRS5XZWJHTFJlbmRlcmVyKHtcclxuICAgIGFudGlhbGlhczogdHJ1ZSxcclxuICB9KTtcclxuICBASW5wdXQoKSBjb250cm9sczogYW55IHwgbnVsbCA9IG51bGw7XHJcbiAgQElucHV0KCkgbWVzaE9wdGlvbnM6IE1lc2hPcHRpb25zW10gPSBbXTtcclxuXHJcbiAgQE91dHB1dCgpIHJlbmRlcmVkID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xyXG5cclxuICB4ekFuZ2xlID0gMDsgLy8gQXppbXV0aGFsIGFuZ2xlXHJcbiAgeXpBbmdsZSA9IDA7IC8vIFBvbGFyIGFuZ2xlXHJcbiAgZGlzdGFuY2UgPSAxMDsgLy8gUGVyc3BlY3RpdmVDYW1lcmEgZGlzdGFuY2VcclxuICB6b29tRmFjdG9yID0gMDsgLy8gT3J0aG9ncmFwaGljQ2FtZXJhIHpvb21cclxuXHJcbiAgdGV4dHVyZTogVEhSRUUuQ3ViZVRleHR1cmU7XHJcblxyXG4gIGhhc1dlYkdMID0gaXNXZWJHTEF2YWlsYWJsZSgpO1xyXG4gIG1lc2hHcm91cCA9IG5ldyBUSFJFRS5PYmplY3QzRCgpO1xyXG4gIGlzUmVuZGVyZWQgPSBmYWxzZTtcclxuICBzaG93U3RsTW9kZWwgPSB0cnVlO1xyXG4gIHN0bExvYWRlciA9IG5ldyBTVExMb2FkZXIoKTtcclxuICBsaWdodFByb2JlID0gbmV3IFRIUkVFLkxpZ2h0UHJvYmUodW5kZWZpbmVkLCAxKTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBwcml2YXRlIGVsZVJlZjogRWxlbWVudFJlZixcclxuICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmVcclxuICApIHtcclxuICAgIHRoaXMuY2RyLmRldGFjaCgpO1xyXG4gICAgLy8gZGVmYXVsdCBsaWdodCBwb3NpdGlvblxyXG4gICAgdGhpcy5saWdodC5wb3NpdGlvbi5zZXQoMTAsIDEwLCAxMCk7XHJcblxyXG4gICAgLy8gZGVmYXVsdCBjYW1lcmEgcG9zaXRpb25cclxuICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnNldCgwLCB0aGlzLmRpc3RhbmNlLCAwKTtcclxuICAgIHRoaXMuY2FtZXJhLmxvb2tBdCgwLCAwLCAwKTtcclxuXHJcbiAgICAvLyBkZWZhdWx0IHNjZW5lIGJhY2tncm91bmRcclxuICAgIHRoaXMuc2NlbmUuYmFja2dyb3VuZCA9IG5ldyBUSFJFRS5Db2xvcigweGRjZGNkYyk7XHJcbiAgICBuZXcgVEhSRUUuQ3ViZVRleHR1cmVMb2FkZXIoKS5sb2FkKFxyXG4gICAgICB0aGlzLmdlbkN1YmVVcmxzKCdhc3NldHMvJywgJy5wbmcnKSxcclxuICAgICAgKGN1YmVUZXh0dXJlKSA9PiB7XHJcbiAgICAgICAgY3ViZVRleHR1cmUuZW5jb2RpbmcgPSBUSFJFRS5zUkdCRW5jb2Rpbmc7XHJcbiAgICAgICAgdGhpcy5saWdodFByb2JlLmNvcHkoTGlnaHRQcm9iZUdlbmVyYXRvci5mcm9tQ3ViZVRleHR1cmUoY3ViZVRleHR1cmUpKTtcclxuICAgICAgICAvLyB0aGlzLnNjZW5lLmJhY2tncm91bmQgPSBjdWJlVGV4dHVyZTtcclxuICAgICAgICB0aGlzLnRleHR1cmUgPSBjdWJlVGV4dHVyZTtcclxuICAgICAgICB0aGlzLm1hdGVyaWFsID0gbmV3IFRIUkVFLk1lc2hTdGFuZGFyZE1hdGVyaWFsKHtcclxuICAgICAgICAgIGNvbG9yOiAweGZmZmZmZixcclxuICAgICAgICAgIG1ldGFsbmVzczogMC40LFxyXG4gICAgICAgICAgcm91Z2huZXNzOiAwLjIsXHJcbiAgICAgICAgICBlbnZNYXA6IGN1YmVUZXh0dXJlLFxyXG4gICAgICAgICAgZW52TWFwSW50ZW5zaXR5OiAxLFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICApO1xyXG5cclxuICAgIC8vIGRlZmF1bHQgcmVuZGVyZXIgb3B0aW9uc1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRQaXhlbFJhdGlvKHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvKTtcclxuICAgIHRoaXMucmVuZGVyZXIuc2hhZG93TWFwLmVuYWJsZWQgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLy8gZW52bWFwXHJcbiAgcHJpdmF0ZSBnZW5DdWJlVXJscyhwcmVmaXgsIHBvc3RmaXgpIHtcclxuICAgIHJldHVybiBbXHJcbiAgICAgIHByZWZpeCArICdiZycgKyBwb3N0Zml4LFxyXG4gICAgICBwcmVmaXggKyAnYmcnICsgcG9zdGZpeCxcclxuICAgICAgcHJlZml4ICsgJ2JnJyArIHBvc3RmaXgsXHJcbiAgICAgIHByZWZpeCArICdiZycgKyBwb3N0Zml4LFxyXG4gICAgICBwcmVmaXggKyAnYmcnICsgcG9zdGZpeCxcclxuICAgICAgcHJlZml4ICsgJ2JnJyArIHBvc3RmaXgsXHJcbiAgICBdO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICBpZiAoIXRoaXMuaGFzV2ViR0wpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihcclxuICAgICAgICAnc3RsLW1vZGVsLXZpZXdlcjogU2VlbXMgbGlrZSB5b3VyIHN5c3RlbSBkb2VzIG5vdCBzdXBwb3J0IHdlYmdsLidcclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgdGhpcy5pbml0KCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMub25XaW5kb3dSZXNpemUsIGZhbHNlKTtcclxuXHJcbiAgICB0aGlzLm1lc2hHcm91cC5yZW1vdmUoKTtcclxuXHJcbiAgICBpZiAodGhpcy5yZW5kZXJlcikge1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbmRlckxpc3RzLmRpc3Bvc2UoKTtcclxuICAgICAgdGhpcy5yZW5kZXJlci5kaXNwb3NlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuY2FtZXJhKSB7XHJcbiAgICAgIHRoaXMuY2FtZXJhLnJlbW92ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmxpZ2h0KSB7XHJcbiAgICAgIHRoaXMubGlnaHQucmVtb3ZlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMubWF0ZXJpYWwpIHtcclxuICAgICAgdGhpcy5tYXRlcmlhbC5kaXNwb3NlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuY29udHJvbHMpIHtcclxuICAgICAgdGhpcy5jb250cm9scy5yZW1vdmVFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCB0aGlzLnJlbmRlcik7XHJcbiAgICAgIHRoaXMuY29udHJvbHMuZGlzcG9zZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnNjZW5lKSB7XHJcbiAgICAgIHRoaXMuc2NlbmUuY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IHtcclxuICAgICAgICB0aGlzLnNjZW5lLnJlbW92ZShjaGlsZCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICB0aGlzLnNjZW5lLmRpc3Bvc2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHpvb20oZGlyZWN0aW9uOiBab29tRGlyZWN0aW9uLCBzdGVwQ291bnQgPSAxKSB7XHJcbiAgICBpZiAodGhpcy5jYW1lcmEgaW5zdGFuY2VvZiBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSkge1xyXG4gICAgICBzd2l0Y2ggKGRpcmVjdGlvbikge1xyXG4gICAgICAgIGNhc2UgWm9vbURpcmVjdGlvbi5pbjpcclxuICAgICAgICAgIHRoaXMuZGlzdGFuY2UgKz0gc3RlcENvdW50O1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBab29tRGlyZWN0aW9uLm91dDpcclxuICAgICAgICAgIHRoaXMuZGlzdGFuY2UgLT0gc3RlcENvdW50O1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5kaXN0YW5jZSA9IHRoaXMuZGlzdGFuY2UgPCAwID8gMCA6IHRoaXMuZGlzdGFuY2U7XHJcbiAgICB9XHJcbiAgICB0aGlzLnJvdGF0ZShSb3RhdGVEaXJlY3Rpb24ubm9uZSk7XHJcbiAgfVxyXG4gIHJvdGF0ZShkaXJlY3Rpb246IFJvdGF0ZURpcmVjdGlvbiwgc3RlcENvdW50ID0gMSkge1xyXG4gICAgbGV0IHN0ZXAgPSAwO1xyXG4gICAgc3dpdGNoIChkaXJlY3Rpb24pIHtcclxuICAgICAgY2FzZSBSb3RhdGVEaXJlY3Rpb24udXA6XHJcbiAgICAgICAgc3RlcCA9IDAuMTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBSb3RhdGVEaXJlY3Rpb24ucmlnaHQ6XHJcbiAgICAgICAgdGhpcy54ekFuZ2xlICs9IDAuMTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBSb3RhdGVEaXJlY3Rpb24uZG93bjpcclxuICAgICAgICBzdGVwID0gLTAuMTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBSb3RhdGVEaXJlY3Rpb24ubGVmdDpcclxuICAgICAgICB0aGlzLnh6QW5nbGUgLT0gMC4xO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChNYXRoLmFicyh0aGlzLnl6QW5nbGUgKyBzdGVwICogc3RlcENvdW50KSA8IE1hdGguUEkgLyAyKSB7XHJcbiAgICAgIHRoaXMueXpBbmdsZSArPSBzdGVwO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy55ekFuZ2xlID0gc3RlcCA+IDAgPyBNYXRoLlBJIC8gMiA6IC1NYXRoLlBJIC8gMjtcclxuICAgIH1cclxuICAgIHRoaXMuY2FtZXJhLnBvc2l0aW9uLnggPVxyXG4gICAgICB0aGlzLmRpc3RhbmNlICogTWF0aC5jb3ModGhpcy55ekFuZ2xlKSAqIE1hdGguY29zKHRoaXMueHpBbmdsZSk7XHJcbiAgICB0aGlzLmNhbWVyYS5wb3NpdGlvbi56ID1cclxuICAgICAgdGhpcy5kaXN0YW5jZSAqIE1hdGguY29zKHRoaXMueXpBbmdsZSkgKiBNYXRoLnNpbih0aGlzLnh6QW5nbGUpO1xyXG4gICAgdGhpcy5jYW1lcmEucG9zaXRpb24ueSA9IHRoaXMuZGlzdGFuY2UgKiBNYXRoLnNpbih0aGlzLnl6QW5nbGUpO1xyXG4gICAgdGhpcy5jYW1lcmEubG9va0F0KDAsIDAsIDApO1xyXG4gICAgdGhpcy5yZW5kZXIoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgaW5pdCgpIHtcclxuICAgIHRoaXMuc2NlbmUuYWRkKHRoaXMubGlnaHRQcm9iZSk7XHJcbiAgICB0aGlzLmNhbWVyYS5hZGQodGhpcy5saWdodCk7XHJcbiAgICB0aGlzLnNjZW5lLmFkZCh0aGlzLmNhbWVyYSk7XHJcblxyXG4gICAgLy8gdXNlIGRlZmF1bHQgY29udHJvbHNcclxuICAgIGlmICh0aGlzLmhhc0NvbnRyb2xzICYmICF0aGlzLmNvbnRyb2xzKSB7XHJcbiAgICAgIHRoaXMuY29udHJvbHMgPSBuZXcgT3JiaXRDb250cm9scyh0aGlzLmNhbWVyYSwgdGhpcy5yZW5kZXJlci5kb21FbGVtZW50KTtcclxuICAgICAgdGhpcy5jb250cm9scy5lbmFibGVab29tID0gdHJ1ZTtcclxuXHJcbiAgICAgIHRoaXMuY29udHJvbHMuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgdGhpcy5yZW5kZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLm9uV2luZG93UmVzaXplLCBmYWxzZSk7XHJcblxyXG4gICAgYXdhaXQgdGhpcy5yZWZyZXNoTWVzaEdyb3VwKCk7XHJcblxyXG4gICAgdGhpcy5zY2VuZS5hZGQodGhpcy5tZXNoR3JvdXApO1xyXG4gICAgdGhpcy5lbGVSZWYubmF0aXZlRWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLnJlbmRlcmVyLmRvbUVsZW1lbnQpO1xyXG4gICAgdGhpcy5zZXRTaXplcygpO1xyXG4gICAgdGhpcy5yZW5kZXIoKTtcclxuICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XHJcbiAgICAgIHRoaXMuaXNSZW5kZXJlZCA9IHRydWU7XHJcbiAgICAgIHRoaXMucmVuZGVyZWQuZW1pdCgpO1xyXG4gICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHJlZnJlc2hNZXNoR3JvdXAoKSB7XHJcbiAgICB0aGlzLm1lc2hHcm91cC5yZW1vdmUoLi4udGhpcy5tZXNoR3JvdXAuY2hpbGRyZW4pO1xyXG4gICAgY29uc3QgbWVzaENyZWF0aW9ucyA9IHRoaXMuc3RsTW9kZWxzLm1hcCgobW9kZWxQYXRoLCBpbmRleCkgPT4ge1xyXG4gICAgICByZXR1cm4gdGhpcy5jcmVhdGVNZXNoKG1vZGVsUGF0aCwgdGhpcy5tZXNoT3B0aW9uc1tpbmRleF0pO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCBtZXNoZXM6IFRIUkVFLk9iamVjdDNEW10gPSBhd2FpdCBQcm9taXNlLmFsbChtZXNoQ3JlYXRpb25zKTtcclxuXHJcbiAgICBtZXNoZXMubWFwKChtZXNoKSA9PiB0aGlzLm1lc2hHcm91cC5hZGQobWVzaCkpO1xyXG4gICAgdGhpcy5yb3RhdGUoUm90YXRlRGlyZWN0aW9uLm5vbmUpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgY3JlYXRlTWVzaChcclxuICAgIHBhdGg6IHN0cmluZyxcclxuICAgIG1lc2hPcHRpb25zOiBNZXNoT3B0aW9ucyA9IHt9XHJcbiAgKTogUHJvbWlzZTxUSFJFRS5NZXNoPiB7XHJcbiAgICBjb25zdCBnZW9tZXRyeTogVEhSRUUuQnVmZmVyR2VvbWV0cnkgPSBhd2FpdCB0aGlzLnN0bExvYWRlci5sb2FkQXN5bmMocGF0aCk7XHJcbiAgICBnZW9tZXRyeS5jb21wdXRlQm91bmRpbmdCb3goKTtcclxuICAgIGdlb21ldHJ5LmNlbnRlcigpO1xyXG4gICAgY29uc3QgeyB4LCB5LCB6IH0gPSBnZW9tZXRyeS5ib3VuZGluZ0JveC5tYXg7XHJcbiAgICB0aGlzLmRpc3RhbmNlID0gTWF0aC5tYXgoeCwgeSwgeikgKiAxMDtcclxuXHJcbiAgICBjb25zdCBtZXNoID0gbmV3IFRIUkVFLk1lc2goZ2VvbWV0cnksIHRoaXMubWF0ZXJpYWwpO1xyXG4gICAgbWVzaC5yb3RhdGVPbldvcmxkQXhpcyhuZXcgVEhSRUUuVmVjdG9yMygwLCAxLCAwKSwgLU1hdGguUEkgLyAyKTtcclxuICAgIGNvbnN0IHZlY3Rvck9wdGlvbnMgPSBbJ3Bvc2l0aW9uJywgJ3NjYWxlJywgJ3VwJ107XHJcbiAgICBjb25zdCBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdE1lc2hPcHRpb25zLCBtZXNoT3B0aW9ucyk7XHJcblxyXG4gICAgT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMob3B0aW9ucykuZm9yRWFjaCgob3B0aW9uKSA9PiB7XHJcbiAgICAgIGlmICh2ZWN0b3JPcHRpb25zLmluZGV4T2Yob3B0aW9uKSA+IC0xKSB7XHJcbiAgICAgICAgY29uc3QgdmVjdG9yID0gb3B0aW9uc1tvcHRpb25dIGFzIFZlY3RvcjM7XHJcbiAgICAgICAgY29uc3QgbWVzaFZlY3Rvck9wdGlvbiA9IG1lc2hbb3B0aW9uXSBhcyBWZWN0b3IzO1xyXG4gICAgICAgIG1lc2hWZWN0b3JPcHRpb24uc2V0KHZlY3Rvci54LCB2ZWN0b3IueSwgdmVjdG9yLnopO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1lc2hbb3B0aW9uXSA9IG9wdGlvbnNbb3B0aW9uXTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIG1lc2g7XHJcbiAgfVxyXG5cclxuICByZW5kZXIgPSAoKSA9PiB7XHJcbiAgICB0aGlzLnJlbmRlcmVyLnJlbmRlcih0aGlzLnNjZW5lLCB0aGlzLmNhbWVyYSk7XHJcbiAgfTtcclxuXHJcbiAgc2V0U2l6ZXMoKSB7XHJcbiAgICBjb25zdCB3aWR0aCA9IHRoaXMuZWxlUmVmLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGg7XHJcbiAgICBjb25zdCBoZWlnaHQgPSB0aGlzLmVsZVJlZi5uYXRpdmVFbGVtZW50Lm9mZnNldEhlaWdodDtcclxuXHJcbiAgICB0aGlzLmNhbWVyYS5hc3BlY3QgPSB3aWR0aCAvIGhlaWdodDtcclxuICAgIHRoaXMuY2FtZXJhLnVwZGF0ZVByb2plY3Rpb25NYXRyaXgoKTtcclxuXHJcbiAgICB0aGlzLnJlbmRlcmVyLnNldFNpemUod2lkdGgsIGhlaWdodCk7XHJcbiAgfVxyXG5cclxuICBvbldpbmRvd1Jlc2l6ZSA9ICgpID0+IHtcclxuICAgIHRoaXMuc2V0U2l6ZXMoKTtcclxuICAgIHRoaXMucmVuZGVyKCk7XHJcbiAgfTtcclxufVxyXG4iXX0=